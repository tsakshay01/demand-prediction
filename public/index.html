<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DemandAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col hidden md:flex">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <div class="flex items-center gap-2 text-emerald-500 font-bold text-xl">
                <i data-lucide="brain-circuit" class="w-7 h-7"></i>
                <span>DemandAI</span>
            </div>
        </div>
        <nav class="flex-1 py-6 space-y-1">
            <a href="#"
                class="flex items-center gap-3 px-6 py-3 text-emerald-400 bg-emerald-500/10 border-r-2 border-emerald-500">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="upload.html"
                class="flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-slate-200 hover:bg-slate-900 transition mb-1">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                <span class="font-medium">Data Upload</span>
            </a>
            <a href="settings.html"
                class="flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-slate-200 hover:bg-slate-900 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="font-medium">Settings</span>
            </a>
            <a href="analytics.html"
                class="flex items-center gap-3 px-6 py-3 text-slate-400 hover:text-slate-200 hover:bg-slate-900 transition mb-1">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                <span class="font-medium">Analytics</span>
            </a>
            <a href="admin.html" id="adminLink"
                class="hidden flex items-center gap-3 px-6 py-3 text-rose-400 hover:text-rose-200 hover:bg-rose-900/20 transition border-l-2 border-transparent hover:border-rose-400">
                <i data-lucide="shield-alert" class="w-5 h-5"></i>
                <span class="font-medium">Admin Portal</span>
            </a>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-white font-bold text-sm"
                    id="userInitials"></div>
                <div class="overflow-hidden">
                    <p class="text-sm font-semibold text-white truncate" id="userName">Loading...</p>
                    <p class="text-xs text-slate-500 capitalize" id="userRole">...</p>
                </div>
                <button onclick="logout()" class="ml-auto text-slate-400 hover:text-white"><i data-lucide="log-out"
                        class="w-5 h-5"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative bg-slate-900">
        <header class="h-16 glass-panel border-b border-white/5 flex items-center justify-between px-8 z-10">
            <h1 class="text-xl font-bold text-white flex items-center gap-3">
                <i data-lucide="activity" class="text-emerald-500"></i>
                Demand Forecast
            </h1>
            <div class="flex items-center gap-4">
                <div id="modeIndicator"
                    class="px-3 py-1 rounded-full text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700">
                    Live Mode
                </div>
                <button onclick="window.location.href='upload.html'"
                    class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs rounded-lg flex items-center gap-2">
                    <i data-lucide="upload" class="w-3 h-3"></i> Upload Data
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">

            <!-- Row 0: Data Context Banner (Data Range + Forecast Horizon) -->
            <div id="dataContextBanner" class="glass-panel p-4 rounded-xl border border-slate-700 hidden">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <i data-lucide="calendar-range" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-xs text-slate-400">Data Range:</span>
                            <span id="dataRange" class="text-sm text-white font-medium">--</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="target" class="w-4 h-4 text-emerald-400"></i>
                            <span class="text-xs text-slate-400">Forecast Horizon:</span>
                            <span id="forecastHorizon" class="text-sm text-emerald-400 font-semibold">--</span>
                        </div>
                    </div>
                    <button onclick="clearAnalysis()"
                        class="text-xs text-slate-500 hover:text-red-400 flex items-center gap-1">
                        <i data-lucide="x-circle" class="w-3 h-3"></i> Clear Analysis
                    </button>
                </div>
            </div>

            <!-- Row 1: Primary Forecast Card (THE BIG NUMBER) -->
            <div id="forecastHeroCard" class="glass-panel p-6 rounded-xl border-l-4 border-emerald-500 hidden">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-semibold mb-1">
                            <span id="heroForecastLabel">Next Period Forecast</span>
                        </p>
                        <h2 id="heroForecastValue" class="text-5xl font-bold text-white">--</h2>
                        <p id="heroForecastProduct" class="text-sm text-slate-500 mt-1">Top Product: --</p>
                    </div>
                    <div class="flex flex-col gap-2 text-right">
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-xs text-slate-400">Confidence:</span>
                            <span id="heroConfidence" class="text-sm text-blue-400 font-medium">94%</span>
                        </div>
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-xs text-slate-400">Products Analyzed:</span>
                            <span id="heroProductCount" class="text-sm text-white font-medium">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Chart 1: Historical Demand (Raw Sales History) -->
                <div class="glass-panel p-6 rounded-xl lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">Historical Demand</h3>
                        <span id="chartDataRangeLabel" class="text-xs text-slate-500">Raw Sales Data</span>
                    </div>
                    <div class="h-64">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Product Comparison (Avg Daily Sales) -->
                <div class="glass-panel p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">Product Comparison</h3>
                        <span class="text-xs text-slate-500">Avg. Daily Sales</span>
                    </div>
                    <div class="h-64">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Chart 3: Market Share (Same Stat: Avg Daily Sales) -->
                <div class="glass-panel p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-white">Market Share</h3>
                        <span class="text-xs text-slate-500">By Avg. Daily Sales</span>
                    </div>
                    <div class="h-64 flex justify-center">
                        <canvas id="donutChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- Row 3: Per-Product Forecast Table -->
            <div class="glass-panel p-6 rounded-xl overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-white">Per-Product Forecasts</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-400">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                            <tr>
                                <th class="px-4 py-2">Product</th>
                                <th class="px-4 py-2 text-right">Avg Daily</th>
                                <th class="px-4 py-2 text-right">Forecast</th>
                            </tr>
                        </thead>
                        <tbody id="contextTableBody">
                            <tr>
                                <td colspan="3" class="px-4 py-8 text-center italic">Upload a CSV to see forecasts</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = 'login.html';
            // CRITICAL: Stop execution here - user is null
            throw new Error('Redirecting to login...');
        }
        const token = localStorage.getItem('token');

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }

        // Populate Sidebar
        document.getElementById('userName').innerText = user.name;
        document.getElementById('userRole').innerText = user.role;
        document.getElementById('userInitials').innerText = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        if (user.role === 'admin') document.getElementById('adminLink').classList.remove('hidden');

        // --- CHART INITIALIZATION ---
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false }, ticks: { color: '#64748b' } }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b' } } }
        };

        // Global chart variables
        let lineChart, barChart, donutChart;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 1. Line Chart
                const lineCtx = document.getElementById('lineChart');
                if (lineCtx) {
                    lineChart = new Chart(lineCtx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: { ...commonOptions, interaction: { mode: 'index', intersect: false }, scales: { x: { display: false }, y: { grid: { color: '#334155' }, ticks: { color: '#64748b' } } } }
                    });
                }

                // 2. Bar Chart
                const barCtx = document.getElementById('barChart');
                if (barCtx) {
                    barChart = new Chart(barCtx, {
                        type: 'bar',
                        data: { labels: [], datasets: [] },
                        options: { ...commonOptions, indexAxis: 'y' }
                    });
                }

                // 3. Donut Chart
                const donutCtx = document.getElementById('donutChart');
                if (donutCtx) {
                    donutChart = new Chart(donutCtx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } },
                            cutout: '70%',
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                }
            } catch (e) {
                console.error("Chart Init Error:", e);
            }
        });

        // --- LOGIC ---

        function initDashboard() {
            // Priority: If localStorage has analysis data, show it (regardless of URL).
            // This ensures returning from Settings etc. still shows the chart.
            const saved = localStorage.getItem('csv_prediction');
            if (saved) {
                loadAnalysisData();
            } else {
                loadLiveStats();
                monitorSignals();
                setInterval(monitorSignals, 10000);
            }
        }

        function loadAnalysisData() {
            const saved = localStorage.getItem('csv_prediction');
            if (!saved) return;

            try {
                const parsed = JSON.parse(saved);
                let items = parsed.data;

                if (!items || items.length === 0) return;

                // Show analysis-specific UI elements
                document.getElementById('dataContextBanner').classList.remove('hidden');
                document.getElementById('forecastHeroCard').classList.remove('hidden');
                document.getElementById('modeIndicator').innerText = "Analysis: " + parsed.filename;
                document.getElementById('modeIndicator').className = "px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-400 border border-emerald-500/50";

                // Normalize Data Structure (Support both Old & New Formats)
                const validItems = items.map(i => {
                    let hist = i.history || i.sales_history;
                    if (typeof hist === 'string') {
                        try { hist = JSON.parse(hist); } catch (e) { hist = []; }
                    }
                    const histArray = Array.isArray(hist) ? hist : [];
                    const avgDaily = histArray.length > 0 ? histArray.reduce((a, b) => a + b, 0) / histArray.length : 0;
                    return {
                        description: i.description || 'Unknown Product',
                        history: histArray,
                        prediction: i.prediction || i.predicted_demand || 0,
                        avgDaily: avgDaily
                    };
                }).filter(i => i.history && i.history.length > 0);

                if (validItems.length === 0) {
                    console.warn("No valid items with history found.");
                    return;
                }

                // Sort by prediction (forecast) descending
                const topItems = validItems.sort((a, b) => b.prediction - a.prediction).slice(0, 5);
                const topProduct = topItems[0];

                // --- ADAPTIVE FORECAST HORIZON ---
                const historyLength = topProduct.history.length;
                let dataRangeText = `Last ${historyLength} days`;
                let forecastHorizonText = "Next Period";
                let forecastLabel = "Next Period Forecast";

                if (historyLength <= 7) {
                    forecastHorizonText = "Next Week";
                    forecastLabel = "Next Week Forecast";
                } else if (historyLength <= 14) {
                    forecastHorizonText = "Next 2 Weeks";
                    forecastLabel = "Next 2 Weeks Forecast";
                } else if (historyLength <= 30) {
                    forecastHorizonText = "Next Month";
                    forecastLabel = "Next Month Forecast";
                } else if (historyLength <= 90) {
                    forecastHorizonText = "Next Quarter";
                    forecastLabel = "Next Quarter Forecast";
                } else if (historyLength <= 365) {
                    forecastHorizonText = "Next Year";
                    forecastLabel = "Next Year Forecast";
                }

                // Populate Data Context Banner
                document.getElementById('dataRange').innerText = dataRangeText;
                document.getElementById('forecastHorizon').innerText = forecastHorizonText;

                // Populate Hero Forecast Card
                document.getElementById('heroForecastLabel').innerText = forecastLabel;
                document.getElementById('heroForecastValue').innerText = Math.round(topProduct.prediction).toLocaleString();
                document.getElementById('heroForecastProduct').innerText = `Top Product: ${topProduct.description}`;
                document.getElementById('heroProductCount').innerText = validItems.length;

                // --- CHART 1: Historical Demand (RAW sales_history) ---
                const lineLabels = topProduct.history.map((_, i) => `Day ${i + 1}`);
                document.getElementById('chartDataRangeLabel').innerText = `${historyLength} Days of Sales Data`;
                lineChart.data.labels = lineLabels;
                lineChart.data.datasets = topItems.slice(0, 3).map((item, idx) => ({
                    label: item.description.substring(0, 20),
                    data: item.history, // RAW data, no slicing or interpolation
                    borderColor: ['#10b981', '#3b82f6', '#f59e0b'][idx],
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 1
                }));
                lineChart.update();

                // --- CHART 2: Product Comparison (Avg Daily Sales) ---
                barChart.data.labels = topItems.map(i => i.description.split(' ').slice(0, 2).join(' '));
                barChart.data.datasets = [{
                    label: 'Avg Daily Sales',
                    data: topItems.map(item => Math.round(item.avgDaily)),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }];
                barChart.update();

                // --- CHART 3: Market Share (Same Stat: Avg Daily Sales) ---
                donutChart.data.labels = topItems.map(i => i.description.split(' ').slice(0, 2).join(' '));
                donutChart.data.datasets = [{
                    data: topItems.map(i => Math.round(i.avgDaily)),
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'],
                    borderWidth: 0
                }];
                donutChart.update();

                // --- TABLE: Per-Product Forecasts ---
                const tbody = document.getElementById('contextTableBody');
                if (tbody) {
                    tbody.innerHTML = topItems.map(item => `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                            <td class="px-4 py-3 font-medium text-white truncate max-w-xs">${item.description}</td>
                            <td class="px-4 py-3 text-right font-mono text-slate-400">${Math.round(item.avgDaily).toLocaleString()}</td>
                            <td class="px-4 py-3 text-right font-mono text-emerald-400 font-semibold">${Math.round(item.prediction).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }

                lucide.createIcons();

            } catch (e) { console.error("Dashboard Render Error", e); }
        }

        function clearAnalysis() {
            localStorage.removeItem('csv_prediction');
            window.location.reload();
        }

        async function loadLiveStats() {
            try {
                const res = await fetch('/api/dashboard/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                const stats = await res.json();
                document.getElementById('kpiForecast').innerText = stats.totalDemand;
                document.getElementById('kpiTopProduct').innerText = stats.topProduct;

                // Monitor Signals
                const sigRes = await fetch('/api/market-signals');
                const context = await sigRes.json();
                updateBadges(context);
            } catch (e) { console.error("Live Stats Error", e); }
        }

        async function monitorSignals() {
            try {
                const res = await fetch('/api/market-signals');
                const context = await res.json();
                updateBadges(context);
            } catch (err) { console.error("Signal Monitor Error:", err); }
        }

        function updateBadges(context) {
            const wBadge = document.getElementById('badgeWeather');
            const sBadge = document.getElementById('badgeSocial');

            if (wBadge) {
                wBadge.className = context.weather.status === "CLEAR" ? "flex items-center gap-2 text-xs text-slate-400" : "flex items-center gap-2 text-xs text-amber-400 font-bold animate-pulse";
                wBadge.innerHTML = `<i data-lucide="${context.weather.status === 'CLEAR' ? 'sun' : 'cloud-lightning'}" class="w-4 h-4"></i> Weather: ${context.weather.status}`;
            }
            if (sBadge) {
                sBadge.innerHTML = `<i data-lucide="message-square" class="w-4 h-4"></i> Social: ${context.social.status}`;
            }
            lucide.createIcons();
        }

        initDashboard();

    </script>
</body>

</html>